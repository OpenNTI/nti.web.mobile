<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/main/js/login/LoginController.js - NextThought Mobile</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.7.0/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
        
	    <img alt="NextThought Mobile" src="../assets/css/logo.png" style="max-height: 65%;" title="NextThought Mobile">
        
            NextThought Mobile
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>0.0.0</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/AppConfig", "classes/Button", "classes/DebugInfo", "classes/HTTP_STATUS_CODES", "classes/LoginActions", "classes/LoginConstants", "classes/LoginController", "classes/LoginForm", "classes/LoginPanel", "classes/ResponseHandlers", "classes/Utils"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
    <h3>APIs</h3>
    <div id="sidebar">
        <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
            <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
            <li><a href="#modules" data-toggle="tab">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" placeholder="Type to filter APIs">
        </div>

        <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
            <div class="tab-pane active" id="classes">
                <ul id="api-classes" class="nav nav-list">
                    
                        <li><a href="../classes/AppConfig.html">AppConfig</a></li>
                    
                        <li><a href="../classes/Button.html">Button</a></li>
                    
                        <li><a href="../classes/DebugInfo.html">DebugInfo</a></li>
                    
                        <li><a href="../classes/HTTP_STATUS_CODES.html">HTTP_STATUS_CODES</a></li>
                    
                        <li><a href="../classes/LoginActions.html">LoginActions</a></li>
                    
                        <li><a href="../classes/LoginConstants.html">LoginConstants</a></li>
                    
                        <li><a href="../classes/LoginController.html">LoginController</a></li>
                    
                        <li><a href="../classes/LoginForm.html">LoginForm</a></li>
                    
                        <li><a href="../classes/LoginPanel.html">LoginPanel</a></li>
                    
                        <li><a href="../classes/ResponseHandlers.html">ResponseHandlers</a></li>
                    
                        <li><a href="../classes/Utils.html">Utils</a></li>
                    
                </ul>
            </div>

            <div class="tab-pane" id="modules">
                <ul id="api-modules" class="nav nav-list">
                    
                </ul>
            </div>
        </div>
    </div>
</div>

        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <div class="page-header">
    <h1>src/main/js/login/LoginController.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
/*
 * LoginController
 */
&#x27;use strict&#x27;;

var AppDispatcher = require(&#x27;../common/dispatcher/AppDispatcher&#x27;);
var AppConfig = require(&#x27;../common/AppConfig&#x27;);
var EventEmitter = require(&#x27;events&#x27;).EventEmitter;
var LoginConstants = require(&#x27;./LoginConstants&#x27;);
var HttpStatusCodes = require(&#x27;../common/constants/HttpStatusCodes&#x27;);
var merge = require(&#x27;react/lib/merge&#x27;);
var Utils = require(&#x27;../common/Utils&#x27;);

var CHANGE_EVENT = &#x27;change&#x27;;

/**
* Sends a ping to the dataserver to retrieve a &#x27;Pong&#x27; containing links for available next steps.
* @method begin
*/
function begin() {
	$.ajax({
		dataType: &#x27;json&#x27;,
		url:&#x27;/dataserver2/logon.ping&#x27;, // TODO: get this url from config?
		headers: {Accept:&#x27;application/json&#x27;},
		type: &#x27;GET&#x27;
	})
	.done(ResponseHandlers.pong)
	.fail(function(){
		console.log(&#x27;LoginController::begin failed.&#x27;);
	});
}

/**
* Attempt a login using the provided credentials.
* @method log_in
* @param {Object} credentials The credentials (currently expects username, password)
*/
function log_in(credentials) {
	console.log(&quot;LoginController::login&quot;, credentials);
	var url = LoginController.getHref(LoginConstants.LOGIN_PASSWORD_LINK);
	Utils.call(url,credentials,ResponseHandlers.login,&#x27;GET&#x27;);
}

/**
* Collection of methods for handling responses from the dataserver related to logins.
* @class ResponseHandlers
*/
var ResponseHandlers = {
	/**
	* Handles a &#x27;pong&#x27; response from a call to dataserver &#x27;ping&#x27;.
	* @method pong
	* @param {mixed} response The response from the call.
	*/
	pong: function(response) {
		var auth = {
			username: &#x27;ray.hatfield@gmail.com&#x27;,
			password: &#x27;ray.hatfield&#x27;,
			remember: true
		};
		var handshakeLink = Utils.getLink(response, LoginConstants.HANDSHAKE);
		if(response &amp;&amp; response.hasOwnProperty(&#x27;Links&#x27;)) {
			// index the links by their &#x27;rel&#x27; attr
			var links_by_rel = Utils.indexArrayByKey(response[&#x27;Links&#x27;],&#x27;rel&#x27;);
			LoginController.setState({links: links_by_rel});
		}
		Utils.call(handshakeLink.href,auth,ResponseHandlers.handshake);
	},

	/**
	* Handles response from a call to a dataserver password login attempt.
	* @method login
	* @param {mixed} response The response from the call.
	*/
	login: function(response) {

		var responseType = typeof response;

		if(responseType == &#x27;number&#x27;) {
			switch(response) {
				case HttpStatusCodes.NO_CONTENT:
				case HttpStatusCodes.NO_CONTENT_IE8:
					debugger;
					console.log(&quot;Login successful.&quot;);
					// TODO: login failed. communicate this to the user.
					return;
				break;
			}
		}
		
		if( responseType == &#x27;number&#x27; &amp;&amp; response !== HttpStatusCodes.NO_CONTENT
			|| (responseType == &#x27;object&#x27; &amp;&amp; !response.success)
			|| !response )
		{
			console.log(&#x27;login failed.&#x27;);
			// TODO: login failed. communicate this to the user.
			return;
		}

		// TODO: login successful. communicate this to the app.
		console.log(&quot;Login successful.&quot;);
		debugger;

		// var t = typeof o;

		// if((t === &#x27;number&#x27; &amp;&amp; o !== 204 &amp;&amp; o !== 1223) || (t === &#x27;object&#x27; &amp;&amp; !o.success) || !o){

		// 	var msg = null;
		// 	if(t === &#x27;number&#x27; &amp;&amp; o == 401){
		// 		msg = getString(&#x27;The username or password you entered is incorrect. Please try again.&#x27;);
		// 	}
		// 	return error(msg);
		// }
		// document.getElementById(&#x27;mask-msg&#x27;).innerHTML = getString(&#x27;Redirecting...&#x27;);
		// redirect();

	},

	/**
	* Handles response from a dataserver handshake call.
	* @method login
	* @param {mixed} response The response from the call.
	*/
	handshake: function(response) {
		console.log(&#x27;handshake handler.&#x27;);
		if(response &amp;&amp; response.hasOwnProperty(&#x27;Links&#x27;)) {
			// index the links by their &#x27;rel&#x27; attr
			var links_by_rel = Utils.indexArrayByKey(response[&#x27;Links&#x27;],&#x27;rel&#x27;);
			LoginController.setState({links: links_by_rel});
		}


		// from NextThoughtLoginApp login.js:
		//
		// resetForPingHandshake();
		// if(typeof o === &#x27;number&#x27; || !o){
		// 	error();
		// 	return;
		// }

		// if(showErrorOnReady &amp;&amp; $.isFunction(showErrorOnReady)){
		// 	showErrorOnReady.call();
		// 	showErrorOnReady = null;
		// }

		// if(o.offline){
		// 	offline();
		// 	return;
		// }

		// addOAuthButtons(o.Links || [], true);
		// updateSubmitButton();

	}
}

/**
 * Coordinates login actions between the view and the dataserver
 * and emits related events.
 * @class LoginController
 */
var LoginController = merge(EventEmitter.prototype, {

	state: {
		links:{},
		isLoggedIn: false
	},

	/**
	* Indicates whether we have the necessary information required to attempt 
	* a password login.
	* The current implementation simply reflects whether we have a link
	* with rel=logon.nti.password
	*
	* @method canDoPasswordLogin
	* @return {boolean} Whether we have the necessary information required
	* to attempt a password login.
	*/
	canDoPasswordLogin: function() {
		return this.getHref(LoginConstants.LOGIN_PASSWORD_LINK) != null;
	},

	/**
	* Indicates whether we&#x27;re currently logged in.
	* @method isLoggedIn
	* @return {boolean} Whether we&#x27;re currently logged in.
	*/
	isLoggedIn: function() {
		return this.state.isLoggedIn;
	},

	/**
	* Updates the state with properties from data. They will be merged with the
	* current state so it is acceptable and expected for the argument to contain only the
	* parts it cares about. While this mimicks the signature of the React method, this is
	* not a React component and should not be confused with one.
	* @method setState
	* @param {Object} data Object representing the changed state.
	*/
	setState:function(data) {
		this.state = merge(this.state,data);
		this.emit(CHANGE_EVENT);
	},

	/**
	* Looks up a link by its rel attribute and returns its href.
	* @method getHref
	* @param {String} link_rel The rel attribute of the sought link.
	* @return {String} The href for the link with the specified rel attribute, or null.
	*/
	getHref: function(link_rel) {
		return this.state.links.hasOwnProperty(link_rel) ? this.state.links[link_rel].href : null;
	},

	emitChange: function() {
		this.emit(CHANGE_EVENT);
	},

	/**
	 * Register to be notified of state changes for this LoginController.
	 * @method addChangeListener
	 * @param {function} callback Function to be invoked in response to a change event.
	 */
	addChangeListener: function(callback) {
		this.on(CHANGE_EVENT, callback);
	},

	/**
	 * Un-register a previously registered event callback listener
	 * @method removeChangeListener
	 * @param {function} callback The callback to un-register.
	 */
	removeChangeListener: function(callback) {
		this.removeListener(CHANGE_EVENT, callback);
	}
});

// Register to handle all updates
AppDispatcher.register(function(payload) {
	var action = payload.action;

	switch(action.actionType) {
		case LoginConstants.LOGIN_BEGIN:
			console.log(&quot;LoginController: LOGIN_BEGIN.&quot;);
			begin();
			LoginController.emitChange();
		break;

		case LoginConstants.LOGIN_PASSWORD:
			console.log(&quot;LoginController: LOGIN_PASSWORD.&quot;);
			log_in(action.credentials);
			LoginController.emitChange();
		break;

		default:
			return true;
	}

	return true; // No errors.  Needed by promise in Dispatcher.
});

module.exports = LoginController;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
